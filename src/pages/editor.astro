---
// Dev-only editor — redirect in production
if (import.meta.env.PROD) {
  return Astro.redirect('/');
}

const pages = [
  { label: 'Home', path: '/' },
  { label: 'Who We Are', path: '/who-we-are' },
  { label: 'Who We Work With', path: '/who-we-work-with' },
  { label: 'What We Do', path: '/what-we-do' },
  { label: 'Process', path: '/process' },
  { label: 'Work', path: '/work' },
  { label: 'Work — Walker', path: '/work/walker-inspection' },
  { label: 'Work — PRC', path: '/work/prc' },
  { label: 'Work — MTN Mud', path: '/work/mtn-mud' },
  { label: 'Work — Wood Wireline', path: '/work/wood-wireline' },
  { label: 'Contact', path: '/contact' },
  { label: 'Podcast', path: '/podcast' },
];
---

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Site Editor | KUT | THRU</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    /* ══════════════════════════════════════
       ROOT / RESET
       ══════════════════════════════════════ */
    :root {
      --a-bg: #0f1117;
      --a-surface: #1a1d27;
      --a-surface-2: #22252f;
      --a-border: #2a2d3a;
      --a-border-l: #363a4a;
      --a-accent: #3b82f6;
      --a-accent-h: #2563eb;
      --a-green: #10b981;
      --a-yellow: #f59e0b;
      --a-red: #EC1D23;
      --a-text: #e5e7eb;
      --a-muted: #6b7280;
      --a-dim: #4b5060;
      --a-radius: 6px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--a-bg);
      color: var(--a-text);
      overflow: hidden;
      height: 100vh;
    }

    /* ══════════════════════════════════════
       ADMIN TOP BAR
       ══════════════════════════════════════ */
    .admin-bar {
      position: fixed; top: 0; left: 0; right: 0; height: 48px;
      background: var(--a-bg); border-bottom: 1px solid var(--a-border);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px; z-index: 10000;
    }
    .ab-left, .ab-center, .ab-right { display: flex; align-items: center; gap: 8px; }

    .ab-logo {
      font-size: 11px; font-weight: 700; color: var(--a-red);
      font-family: 'JetBrains Mono', monospace; letter-spacing: 0.5px;
      display: flex; align-items: center; gap: 6px;
    }
    .ab-logo svg { width: 16px; height: 16px; }
    .ab-sep { width: 1px; height: 22px; background: var(--a-border); }

    .ab-page-sel {
      background: var(--a-surface); border: 1px solid var(--a-border);
      color: var(--a-text); padding: 5px 10px; border-radius: var(--a-radius);
      font-family: inherit; font-size: 12px; cursor: pointer; outline: none;
    }
    .ab-page-sel:hover { border-color: var(--a-border-l); }

    .ab-mode-group {
      display: flex; background: var(--a-surface); border-radius: var(--a-radius);
      padding: 2px; border: 1px solid var(--a-border); gap: 2px;
    }
    .ab-mode {
      padding: 4px 12px; border-radius: 4px; font-size: 11px; font-weight: 600;
      font-family: inherit; border: none; cursor: pointer;
      color: var(--a-muted); background: transparent;
      display: flex; align-items: center; gap: 4px; transition: all .15s;
    }
    .ab-mode svg { width: 13px; height: 13px; }
    .ab-mode.active { background: var(--a-accent); color: #fff; }
    .ab-mode:not(.active):hover { color: var(--a-text); }

    .ab-btn {
      padding: 5px 12px; border-radius: var(--a-radius);
      font-size: 11px; font-weight: 600; font-family: inherit;
      border: 1px solid var(--a-border); cursor: pointer;
      display: flex; align-items: center; gap: 4px; transition: all .12s;
    }
    .ab-btn svg { width: 13px; height: 13px; }
    .ab-ghost { background: transparent; color: var(--a-muted); }
    .ab-ghost:hover { color: var(--a-text); background: var(--a-surface); }
    .ab-save { background: var(--a-accent); color: #fff; border-color: var(--a-accent); }
    .ab-save:hover { background: var(--a-accent-h); }

    .unsaved-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--a-yellow); display: none;
    }
    .unsaved-dot.on { display: block; }

    /* ══════════════════════════════════════
       MAIN LAYOUT
       ══════════════════════════════════════ */
    .editor-layout {
      display: flex; height: calc(100vh - 48px); margin-top: 48px;
    }

    .iframe-wrap {
      flex: 1; position: relative; background: #000;
    }
    .iframe-wrap iframe {
      width: 100%; height: 100%; border: none;
    }

    /* ══════════════════════════════════════
       IMAGE LIBRARY PANEL
       ══════════════════════════════════════ */
    .panel {
      width: 360px; background: var(--a-surface);
      border-left: 1px solid var(--a-border);
      display: flex; flex-direction: column;
      transition: width .2s;
      overflow: hidden;
    }
    .panel.collapsed { width: 0; border: none; }

    .panel-toggle {
      position: absolute; right: 360px; top: 50%;
      transform: translateY(-50%);
      width: 20px; height: 48px;
      background: var(--a-surface); border: 1px solid var(--a-border);
      border-right: none; border-radius: 6px 0 0 6px;
      color: var(--a-muted); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      z-index: 10; transition: right .2s;
    }
    .panel.collapsed ~ .panel-toggle { right: 0; }
    .panel-toggle:hover { color: var(--a-text); }
    .panel-toggle svg { width: 12px; height: 12px; }

    .panel-header {
      padding: 14px 16px; border-bottom: 1px solid var(--a-border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .panel-header h2 {
      font-size: 13px; font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 0.3px;
    }
    .panel-header .count {
      font-size: 10px; color: var(--a-muted);
      background: var(--a-bg); padding: 2px 8px;
      border-radius: 10px; font-weight: 600;
    }

    /* Selected element indicator */
    .selected-indicator {
      padding: 10px 16px; background: rgba(59, 130, 246, 0.08);
      border-bottom: 1px solid var(--a-border);
      font-size: 11px; display: none;
    }
    .selected-indicator.on { display: block; }
    .selected-indicator .key {
      font-family: 'JetBrains Mono', monospace;
      color: var(--a-accent); font-weight: 600;
    }
    .selected-indicator .type {
      color: var(--a-muted); margin-left: 6px;
    }

    /* Search */
    .panel-search {
      padding: 10px 16px; border-bottom: 1px solid var(--a-border);
    }
    .search-input {
      width: 100%; background: var(--a-bg); border: 1px solid var(--a-border);
      border-radius: var(--a-radius); color: var(--a-text);
      padding: 7px 10px 7px 32px; font-size: 12px;
      font-family: inherit; outline: none;
    }
    .search-input:focus { border-color: var(--a-accent); }
    .search-wrap {
      position: relative;
    }
    .search-wrap svg {
      position: absolute; left: 10px; top: 50%;
      transform: translateY(-50%);
      width: 14px; height: 14px; color: var(--a-muted);
      pointer-events: none;
    }

    /* Upload zone */
    .upload-zone {
      margin: 10px 16px; border: 2px dashed var(--a-border);
      border-radius: 8px; padding: 14px; text-align: center;
      cursor: pointer; transition: all .15s;
    }
    .upload-zone:hover { border-color: var(--a-accent); background: rgba(59,130,246,.04); }
    .upload-zone.drag-over { border-color: var(--a-accent); background: rgba(59,130,246,.08); }
    .upload-zone svg { width: 20px; height: 20px; color: var(--a-muted); margin-bottom: 4px; }
    .upload-zone p { font-size: 11px; color: var(--a-muted); }
    .upload-zone span { font-size: 10px; color: var(--a-dim); }

    /* Folder list */
    .folder-list {
      flex: 1; overflow-y: auto; padding: 8px 0;
    }
    .folder-list::-webkit-scrollbar { width: 4px; }
    .folder-list::-webkit-scrollbar-track { background: transparent; }
    .folder-list::-webkit-scrollbar-thumb { background: var(--a-border); border-radius: 2px; }

    .folder-item {
      border-bottom: 1px solid var(--a-border);
    }
    .folder-toggle {
      display: flex; align-items: center; gap: 6px;
      padding: 8px 16px; cursor: pointer; width: 100%;
      background: none; border: none; color: var(--a-text);
      font-family: inherit; font-size: 12px; font-weight: 600;
      transition: background .1s;
    }
    .folder-toggle:hover { background: rgba(255,255,255,.03); }
    .folder-toggle svg { width: 12px; height: 12px; color: var(--a-muted); transition: transform .15s; }
    .folder-toggle.open svg { transform: rotate(90deg); }
    .folder-toggle .count-badge {
      font-size: 10px; color: var(--a-dim); font-weight: 400;
      margin-left: auto;
    }

    .folder-images {
      display: none; padding: 4px 12px 8px;
    }
    .folder-images.open { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }

    .thumb {
      aspect-ratio: 1; border-radius: 4px; overflow: hidden;
      cursor: pointer; border: 2px solid transparent;
      transition: all .15s; position: relative;
      background: var(--a-bg);
    }
    .thumb:hover { border-color: var(--a-accent); transform: scale(1.03); }
    .thumb.selected { border-color: var(--a-green); }
    .thumb img {
      width: 100%; height: 100%; object-fit: cover;
      display: block;
    }
    .thumb .fname {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: rgba(0,0,0,.8); padding: 2px 4px;
      font-size: 8px; color: var(--a-text);
      font-family: 'JetBrains Mono', monospace;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      opacity: 0; transition: opacity .15s;
    }
    .thumb:hover .fname { opacity: 1; }

    /* Image preview tooltip */
    .img-preview {
      display: none; position: fixed; z-index: 10005;
      background: var(--a-bg); border: 1px solid var(--a-border);
      border-radius: 8px; padding: 6px; box-shadow: 0 12px 40px rgba(0,0,0,.6);
      pointer-events: none;
    }
    .img-preview.on { display: block; }
    .img-preview img {
      max-width: 280px; max-height: 200px; border-radius: 4px; display: block;
    }
    .img-preview .preview-info {
      font-size: 10px; color: var(--a-muted); padding: 4px 2px 0;
      font-family: 'JetBrains Mono', monospace;
    }

    /* ══════════════════════════════════════
       TOAST
       ══════════════════════════════════════ */
    .toast {
      position: fixed; bottom: 20px; left: 50%;
      transform: translateX(-50%) translateY(70px);
      background: var(--a-bg); border: 1px solid var(--a-border);
      border-radius: 8px; padding: 10px 18px;
      color: var(--a-text); font-size: 12px; font-weight: 500;
      z-index: 10003; box-shadow: 0 8px 30px rgba(0,0,0,.4);
      opacity: 0; transition: all .3s ease;
    }
    .toast.on { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.ok { border-left: 3px solid var(--a-green); }
    .toast.warn { border-left: 3px solid var(--a-yellow); }
    .toast.info { border-left: 3px solid var(--a-accent); }
  </style>
</head>
<body>

<!-- ══════════ ADMIN TOOLBAR ══════════ -->
<div class="admin-bar">
  <div class="ab-left">
    <div class="ab-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
      KUT | THRU EDITOR
    </div>
    <div class="ab-sep"></div>
    <select class="ab-page-sel" id="pageSel">
      {pages.map(p => (
        <option value={p.path}>{p.label}</option>
      ))}
    </select>
    <div class="unsaved-dot" id="dot"></div>
  </div>
  <div class="ab-center">
    <div class="ab-mode-group">
      <button class="ab-mode active" id="editBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        Edit
      </button>
      <button class="ab-mode" id="prevBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        Preview
      </button>
    </div>
  </div>
  <div class="ab-right">
    <button class="ab-btn ab-ghost" id="refreshBtn" title="Refresh iframe">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
      Refresh
    </button>
    <button class="ab-btn ab-save" id="saveBtn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
      Save
    </button>
  </div>
</div>

<!-- ══════════ MAIN LAYOUT ══════════ -->
<div class="editor-layout">
  <!-- Site Iframe -->
  <div class="iframe-wrap">
    <iframe id="siteFrame" src="/?_editor=1"></iframe>
    <button class="panel-toggle" id="panelToggle">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
    </button>
  </div>

  <!-- Image Library Panel -->
  <div class="panel" id="panel">
    <div class="panel-header">
      <h2>Image Library</h2>
      <span class="count" id="totalCount">0 images</span>
    </div>

    <div class="selected-indicator" id="selectedIndicator">
      Editing: <span class="key" id="selectedKey"></span>
      <span class="type" id="selectedType"></span>
    </div>

    <div class="panel-search">
      <div class="search-wrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" class="search-input" id="searchInput" placeholder="Search images..." />
      </div>
    </div>

    <div class="upload-zone" id="uploadZone">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      <p>Drop images here or click to upload</p>
      <span>JPG, PNG, WebP</span>
    </div>
    <input type="file" id="fileInput" accept="image/*" multiple style="display:none" />

    <div class="folder-list" id="folderList">
      <!-- Populated by JS -->
    </div>
  </div>
</div>

<!-- Image Preview Tooltip -->
<div class="img-preview" id="imgPreview">
  <img id="previewImg" src="" alt="" />
  <div class="preview-info" id="previewInfo"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script is:inline>
  // ══════════ STATE ══════════
  let contentData = { version: 1, lastModified: '', pages: {} };
  let imageLibrary = [];
  let allImages = [];
  let selectedElement = null; // { key, type, currentValue }
  let isDirty = false;
  let editMode = true;

  const frame = document.getElementById('siteFrame');
  const pageSel = document.getElementById('pageSel');
  const dot = document.getElementById('dot');
  const panel = document.getElementById('panel');
  const folderList = document.getElementById('folderList');
  const searchInput = document.getElementById('searchInput');
  const totalCount = document.getElementById('totalCount');
  const selectedIndicator = document.getElementById('selectedIndicator');
  const selectedKey = document.getElementById('selectedKey');
  const selectedType = document.getElementById('selectedType');
  const uploadZone = document.getElementById('uploadZone');
  const fileInput = document.getElementById('fileInput');

  // ══════════ INIT ══════════
  async function init() {
    await Promise.all([loadContent(), loadImages()]);
  }

  async function loadContent() {
    try {
      const res = await fetch('/api/content');
      contentData = await res.json();
    } catch (e) {
      console.error('Failed to load content:', e);
    }
  }

  async function loadImages() {
    try {
      const res = await fetch('/api/images');
      const data = await res.json();
      imageLibrary = data.folders;
      allImages = imageLibrary.flatMap(f => f.images.map(img => ({ ...img, folder: f.name })));
      totalCount.textContent = allImages.length + ' images';
      renderFolders(imageLibrary);
    } catch (e) {
      console.error('Failed to load images:', e);
      folderList.innerHTML = '<div style="padding:20px;text-align:center;color:var(--a-muted);font-size:12px">Failed to load images. Is the dev server running?</div>';
    }
  }

  // ══════════ RENDER FOLDERS ══════════
  function renderFolders(folders) {
    const filter = searchInput.value.toLowerCase().trim();
    folderList.innerHTML = '';

    for (const folder of folders) {
      const images = filter
        ? folder.images.filter(img => img.filename.toLowerCase().includes(filter) || folder.name.toLowerCase().includes(filter))
        : folder.images;
      if (images.length === 0) continue;

      const item = document.createElement('div');
      item.className = 'folder-item';

      const toggle = document.createElement('button');
      toggle.className = 'folder-toggle';
      toggle.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
        ${escHtml(folder.name)}
        <span class="count-badge">${images.length}</span>
      `;

      const grid = document.createElement('div');
      grid.className = 'folder-images';

      for (const img of images) {
        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        if (selectedElement && selectedElement.currentValue === img.path) {
          thumb.classList.add('selected');
        }
        thumb.innerHTML = `
          <img src="${escAttr(img.path)}" alt="${escAttr(img.filename)}" loading="lazy" />
          <div class="fname">${escHtml(img.filename)}</div>
        `;
        thumb.addEventListener('click', () => assignImage(img.path));
        thumb.addEventListener('mouseenter', (e) => showPreview(e, img));
        thumb.addEventListener('mouseleave', hidePreview);
        grid.appendChild(thumb);
      }

      toggle.addEventListener('click', () => {
        toggle.classList.toggle('open');
        grid.classList.toggle('open');
      });

      // Auto-open if searching
      if (filter) {
        toggle.classList.add('open');
        grid.classList.add('open');
      }

      item.appendChild(toggle);
      item.appendChild(grid);
      folderList.appendChild(item);
    }

    if (folderList.children.length === 0) {
      folderList.innerHTML = '<div style="padding:20px;text-align:center;color:var(--a-muted);font-size:12px">No images found</div>';
    }
  }

  // ══════════ IMAGE PREVIEW ══════════
  const imgPreview = document.getElementById('imgPreview');
  const previewImg = document.getElementById('previewImg');
  const previewInfo = document.getElementById('previewInfo');

  function showPreview(e, img) {
    previewImg.src = img.path;
    const sizeKB = img.size ? Math.round(img.size / 1024) + 'KB' : '';
    previewInfo.textContent = img.filename + (sizeKB ? ' · ' + sizeKB : '');
    imgPreview.classList.add('on');
    positionPreview(e);
  }

  function positionPreview(e) {
    const px = imgPreview;
    let x = e.clientX - 300;
    let y = e.clientY - 100;
    if (x < 10) x = 10;
    if (y < 60) y = 60;
    px.style.left = x + 'px';
    px.style.top = y + 'px';
  }

  function hidePreview() {
    imgPreview.classList.remove('on');
  }

  // ══════════ ASSIGN IMAGE ══════════
  function assignImage(imagePath) {
    if (!selectedElement) {
      showToast('Click an image on the page first, then pick from the library', 'warn');
      return;
    }

    const pageKey = getPageKey();
    if (!contentData.pages[pageKey]) contentData.pages[pageKey] = {};
    contentData.pages[pageKey][selectedElement.key] = imagePath;

    // Tell iframe to update
    frame.contentWindow.postMessage({
      type: 'update-content',
      key: selectedElement.key,
      value: imagePath,
      contentType: selectedElement.type
    }, '*');

    selectedElement.currentValue = imagePath;
    markDirty();
    showToast('Image assigned — click Save to persist', 'ok');
    renderFolders(imageLibrary); // refresh selection indicators
  }

  // ══════════ PAGE NAVIGATION ══════════
  pageSel.addEventListener('change', () => {
    const path = pageSel.value;
    frame.src = path + (path.includes('?') ? '&' : '?') + '_editor=1';
    selectedElement = null;
    selectedIndicator.classList.remove('on');
  });

  function getPageKey() {
    const path = pageSel.value;
    if (path === '/') return 'index';
    return path.replace(/^\//, '').replace(/\//g, '-');
  }

  // ══════════ MODE TOGGLE ══════════
  const editBtn = document.getElementById('editBtn');
  const prevBtn = document.getElementById('prevBtn');

  editBtn.addEventListener('click', () => {
    editMode = true;
    editBtn.classList.add('active');
    prevBtn.classList.remove('active');
    frame.contentWindow.postMessage({ type: 'enter-edit-mode' }, '*');
  });

  prevBtn.addEventListener('click', () => {
    editMode = false;
    prevBtn.classList.add('active');
    editBtn.classList.remove('active');
    frame.contentWindow.postMessage({ type: 'exit-edit-mode' }, '*');
    selectedElement = null;
    selectedIndicator.classList.remove('on');
  });

  // ══════════ MESSAGES FROM IFRAME ══════════
  window.addEventListener('message', (e) => {
    if (e.source !== frame.contentWindow) return;
    const msg = e.data;

    if (msg.type === 'element-clicked') {
      selectedElement = {
        key: msg.key,
        type: msg.contentType,
        currentValue: msg.currentValue
      };
      selectedKey.textContent = msg.key;
      selectedType.textContent = msg.contentType;
      selectedIndicator.classList.add('on');
      renderFolders(imageLibrary); // refresh selection indicators

      // If it's an image type, scroll panel to show library
      if (msg.contentType === 'image' || msg.contentType === 'bg-image') {
        panel.classList.remove('collapsed');
      }
    }

    if (msg.type === 'text-changed') {
      const pageKey = getPageKey();
      if (!contentData.pages[pageKey]) contentData.pages[pageKey] = {};
      contentData.pages[pageKey][msg.key] = msg.newValue;
      markDirty();
    }

    if (msg.type === 'page-ready') {
      // Iframe loaded and bridge is ready
      if (editMode) {
        frame.contentWindow.postMessage({ type: 'enter-edit-mode' }, '*');
      }
      // Push any existing content overrides
      const pageKey = getPageKey();
      const pageOverrides = contentData.pages[pageKey];
      if (pageOverrides) {
        for (const [key, value] of Object.entries(pageOverrides)) {
          frame.contentWindow.postMessage({
            type: 'update-content', key, value,
            contentType: key.includes('image') || key.includes('bg') || key.includes('photo') || key.includes('gallery') ? 'image' : 'text'
          }, '*');
        }
      }
    }
  });

  // ══════════ SAVE ══════════
  const saveBtn = document.getElementById('saveBtn');
  saveBtn.addEventListener('click', saveChanges);

  async function saveChanges() {
    try {
      const res = await fetch('/api/content', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(contentData)
      });
      const result = await res.json();
      if (result.success) {
        isDirty = false;
        dot.classList.remove('on');
        showToast('Content saved to content.json', 'ok');
      } else {
        showToast('Save failed: ' + (result.error || 'unknown'), 'warn');
      }
    } catch (e) {
      showToast('Save failed: ' + e.message, 'warn');
    }
  }

  // ══════════ REFRESH ══════════
  document.getElementById('refreshBtn').addEventListener('click', () => {
    frame.contentWindow.location.reload();
    showToast('Page refreshed', 'info');
  });

  // ══════════ PANEL TOGGLE ══════════
  document.getElementById('panelToggle').addEventListener('click', () => {
    panel.classList.toggle('collapsed');
    const toggle = document.getElementById('panelToggle');
    const svg = toggle.querySelector('svg');
    if (panel.classList.contains('collapsed')) {
      svg.innerHTML = '<polyline points="9 18 15 12 9 6"/>';
    } else {
      svg.innerHTML = '<polyline points="15 18 9 12 15 6"/>';
    }
  });

  // ══════════ SEARCH ══════════
  searchInput.addEventListener('input', () => {
    renderFolders(imageLibrary);
  });

  // ══════════ UPLOAD ══════════
  uploadZone.addEventListener('click', () => fileInput.click());
  uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
  uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('drag-over');
    handleUpload(e.dataTransfer.files);
  });
  fileInput.addEventListener('change', () => {
    handleUpload(fileInput.files);
    fileInput.value = '';
  });

  async function handleUpload(files) {
    for (const file of files) {
      if (!file.type.startsWith('image/')) continue;
      const fd = new FormData();
      fd.append('file', file);
      try {
        const res = await fetch('/api/upload', { method: 'POST', body: fd });
        const result = await res.json();
        if (result.success) {
          showToast('Uploaded: ' + result.filename, 'ok');
        }
      } catch (e) {
        showToast('Upload failed: ' + e.message, 'warn');
      }
    }
    // Refresh library
    await loadImages();
  }

  // ══════════ STATE ══════════
  function markDirty() {
    isDirty = true;
    dot.classList.add('on');
  }

  // ══════════ TOAST ══════════
  function showToast(msg, type = 'info') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast ' + type + ' on';
    setTimeout(() => el.classList.remove('on'), 3000);
  }

  // ══════════ KEYBOARD ══════════
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 's') {
      e.preventDefault();
      saveChanges();
    }
  });

  // ══════════ HELPERS ══════════
  function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function escAttr(s) { return s.replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

  // ══════════ LAUNCH ══════════
  init();
</script>

</body>
</html>
